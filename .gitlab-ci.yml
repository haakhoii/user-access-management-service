image: maven:3.9.6-eclipse-temurin-21

stages:
  - build
  - test
  - deploy

variables:
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: Abc123
  AUTH_DB: auth_service
  USER_DB: user_service

  SPRING_PROFILES_ACTIVE: ci
  SPRING_DATASOURCE_USERNAME: postgres
  SPRING_DATASOURCE_PASSWORD: Abc123

  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  key: maven-cache
  paths:
    - .m2/repository

# BUILD
build-job:
  stage: build
  tags: [local]
  script:
    - chmod +x mvnw
    - ./mvnw clean install -DskipTests
  artifacts:
    expire_in: 1 hour
    paths:
      - core-service/target/*.jar
      - auth-service/target/*.jar
      - user-service/target/*.jar

# TEST
test-job:
  stage: test
  tags: [local]
  services:
    - name: postgres:15
      alias: postgres-db

  before_script:
    - chmod +x mvnw

  script:
    # 1. Install core v√†o local repo
    - ./mvnw install -pl core-service -am -DskipTests

    # 2. Test auth
    - export SPRING_PROFILES_ACTIVE=test
    - ./mvnw test -pl auth-service

    # 3. Test user
    - export SPRING_PROFILES_ACTIVE=test
    - ./mvnw test -pl user-service



# DEPLOY
deploy-job:
  stage: deploy
  image: docker:latest
  services:
    - name: docker:dind
  tags: [local]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  only: [main]
  script:
    - docker rm -f auth-service || true
    - |
      docker run -d --name auth-service \
        -p 8081:8081 \
        -v $CI_PROJECT_DIR/auth-service/target/*.jar:/app.jar \
        mcr.microsoft.com/openjdk/jdk:17-ubuntu \
        java -jar /app.jar
